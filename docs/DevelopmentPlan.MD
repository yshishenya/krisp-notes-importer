# План разработки плагина "Krisp Notes Importer"

**Общий подход:** Итеративная разработка с фокусом на скорейшем получении работающей базовой функциональности и ее последующем расширении.

**Инструменты и окружение:**

*   Node.js и npm (или yarn)
*   TypeScript
*   Obsidian API
*   Obsidian Sample Plugin (или аналогичный шаблон для старта)
*   Библиотека `jszip` (или аналогичная) для работы с ZIP.
*   Система контроля версий Git.

---

**Итерация 0: Подготовка и настройка окружения**

*   **Задачи:**
    - [x] 1.  Установить необходимое ПО (Node.js, npm/yarn).
    - [x] 2.  Создать репозиторий Git для проекта.
    - [x] 3.  Инициализировать проект плагина Obsidian, используя официальный шаблон (`obsidian-sample-plugin`) или настроить сборку вручную (`rollup.config.js`, `tsconfig.json`). (используется esbuild)
    - [x] 4.  Настроить `manifest.json` с базовой информацией о плагине (id, имя, версия, автор).
    - [x] 5.  Создать структуру папок и файлов согласно `Architecture.MD` (пустые файлы классов/модулей). (для базовой структуры кода)
    - [x] 6.  Убедиться, что пустой плагин собирается и может быть установлен и активирован в Obsidian (в режиме разработки).
*   **Цель:** Рабочее окружение для разработки, базовый "скелет" плагина.
*   **Критерии завершения:** Пустой плагин успешно собирается, устанавливается и активируется в Obsidian.

---

**Итерация 1: Базовые настройки и их сохранение/загрузка**

*   **Задачи:**
    - [x] 1.  Реализовать `interfaces.ts` с определением интерфейса настроек `KrispImporterSettings` (основные поля из `SRS.MD`, такие как `watchedFolderPath`, `notesFolderPath`, `attachmentsFolderPath`).
    - [x] 2.  Реализовать `SettingsManager.ts`:
        - [x] Методы `load()` и `save()` для настроек с использованием `Plugin.loadData()` и `Plugin.saveData()`.
        - [x] Методы `getSetting()`, `updateSetting()`, `getAllSettings()`.
        - [x] Определить `DEFAULT_SETTINGS`. (используется из `interfaces.ts`)
    - [x] 3.  Реализовать `SettingsTab.ts` (`SettingsUI`):
        - [x] Отображение вкладки настроек в Obsidian.
        - [x] Создание UI-элементов (текстовые поля) для ввода `watchedFolderPath`, `notesFolderPath`, `attachmentsFolderPath`.
        - [x] Привязка UI-элементов к `SettingsManager` для загрузки и сохранения этих трех настроек.
    - [x] 4.  Интегрировать `SettingsManager` и `SettingsTab` в `main.ts` (`MainPlugin`).
*   **Цель:** Пользователь может открыть настройки плагина, ввести и сохранить пути к основным папкам. Настройки должны сохраняться между сессиями Obsidian.
*   **Критерии завершения:**
    - [x]   В Obsidian появляется страница настроек плагина.
    - [x]   Пользователь может ввести и сохранить пути к папке отслеживания, папке заметок и папке вложений.
    - [x]   Значения настроек корректно загружаются при открытии Obsidian.

---

**Итерация 2: Ручной импорт одного ZIP-файла (основной функционал парсинга и создания заметки)**

*   **Задачи:**
    - [x] 1.  Реализовать `ZipExtractor.ts`:
        - [x] Метод `extract(zipFilePath, tempDirPath)` с использованием `jszip`.
        - [x] Метод `cleanup(tempDirPath)`.
    - [x] 2.  Реализовать базовый `NoteParser.ts`:
        - [x] Метод `parseMeetingNotes(notesContent: string, transcriptContent: string, meetingFolderName: string)` для извлечения названия встречи, даты и времени (с корректным regex для обрезки суффикса даты).
        - [x] Метод `parseTranscript(transcriptContent: string)` для извлечения списка участников и форматирования временных меток.
        - [x] Извлечение `Summary`, `Action Items` и `Key Points` из `meeting_notes.txt`.
    - [x] 3.  Реализовать `NoteCreator.ts`:
        - [x] Метод `applyTemplate(templateString, data)` с поддержкой всех плейсхолдеров.
        - [x] Метод `createNote(parsedData, originalAudioPath?)` для создания YAML Frontmatter и сохранения заметки в подпапках `year/month` через `Vault.create()`.
        - [x] Обработка дубликатов согласно стратегии.
        - [x] Создание папок рекурсивно.
    - [x] 4.  Реализовать `ProcessingService.ts`:
        - [x] Основной метод `processZipFile(zipFilePath, settings)`:
            - [x] Вызывает `ZipExtractor`.
            - [x] Читает `meeting_notes.txt`, `transcript.txt`.
            - [x] Вызывает `NoteParser` с правильной сигнатурой.
            - [x] Вызывает `NoteCreator` с правильной сигнатурой.
            - [x] Перемещает `recording.mp3` в `attachmentsFolderPath`.
            - [x] Вызывает `ZipExtractor.cleanup()`.
    - [x] 5.  Реализовать `NotificationService.ts` (с методами `showSuccess`, `showError`, `showWarning`, `showInfo`, `showBatchImportResult`).
    - [x] 6.  Добавить команду в `main.ts` для ручного импорта одного ZIP-файла через модальное окно ввода пути. Команда вызывает `ProcessingService.processZipFile()`.
*   **Цель:** Пользователь может вручную выбрать ZIP-файл Krisp, и плагин создаст заметку с основной информацией и переместит аудиофайл.
*   **Критерии завершения:**
    - [x]   При выборе ZIP-файла через команду, создается Markdown-заметка в указанной папке с подпапками год/месяц.
    - [x]   Заметка содержит название (корректно обрезанное), дату, время, участников, резюме, action items, key points, форматированный транскрипт.
    - [x]   Аудиофайл перемещается в указанную папку с подпапками год/месяц.
    - [x]   Отображаются детальные уведомления об успехе или ошибке через NotificationService.
    - [x]   Обработка дубликатов работает согласно настройкам.
    - [x]   Все плейсхолдеры в шаблонах заполняются корректно.

*   **Исправленные проблемы:**
    - [x] Исправлена логика удаления UUID из имени папки встречи (поддержка формата `-[32-символьный-hex]`).
    - [x] Исправлены плейсхолдеры в шаблоне по умолчанию (interfaces.ts).
    - [x] Добавлена поддержка совместимости со старыми плейсхолдерами в NoteCreator.ts.
    - [x] Исправлена логика копирования аудиофайлов (использование fsPromises.access вместо vault.adapter.exists).
    - [x] Улучшена логика парсинга транскрипта с правильным форматированием временных меток.

*   **Улучшения UX и функциональности (дополнительно):**
    - [x] **Современный HTML5 аудиоплеер** - аудиофайл можно проигрывать прямо из заметки с полноразмерным контроллером.
    - [x] **Улучшенная верстка заметок** - использование Obsidian callouts (`[!info]+`, `[!note]+`, `[!todo]+`, `[!important]+`) для лучшего визуального восприятия.
    - [x] **Сворачиваемый транскрипт** - транскрипт скрыт под `<details>/<summary>` с указанием количества слов для удобства навигации.
    - [x] **Расширенная аналитика участников**:
        - Подсчет количества слов и процентного соотношения активности каждого участника.
        - Количество выступлений каждого участника.
        - Определение самого активного спикера.
    - [x] **Автоматическое извлечение сущностей**:
        - Поиск и извлечение упомянутых проектов, компаний, важных дат.
        - Умное распознавание ключевых терминов и концепций.
    - [x] **Умные теги** - автоматическая генерация тегов на основе содержимого встречи (project, technical, hr, analysis, planning и др.).
    - [x] **Статистическая панель** - детальная таблица с ключевыми метриками встречи.
    - [x] **Связанные материалы** - автоматические ссылки на связанные документы и встречи.
    - [x] **Современное форматирование** - использование эмодзи, визуальных разделителей и структурированной верстки.
    - [x] **Расширенный YAML frontmatter** - добавлена секция `meeting_stats` с детальной аналитикой.
    - [x] **Дата импорта** - отметка времени создания заметки для отслеживания версий.

*   **Статус:** ✅ **ЗАВЕРШЕНО**

---

**Итерация 3: Расширение настроек и шаблонизация**

*   **Задачи:**
    - [ ] 1.  Добавить в `SettingsTab.ts` и `KrispImporterSettings` остальные настройки из `SRS.MD`:
        - [ ] Шаблоны имен для заметок и аудио.
        - [ ] Шаблон содержимого заметки (`noteContentTemplate` - `<textarea>`).
        - [ ] Стратегия обработки дубликатов (`duplicateStrategy`).
        - [ ] Опции `deleteZipAfterImport`, `openNoteAfterImport`.
        - [ ] Язык для дат.
    - [ ] 2.  Улучшить `NoteCreator.ts`:
        - [ ] Реализовать полноценное применение `noteContentTemplate` с заменой всех плейсхолдеров.
        - [ ] Использовать `noteNameTemplate` и `attachmentNameTemplate` при создании/перемещении файлов.
    - [ ] 3.  Улучшить `NoteParser.ts`:
        - [ ] Добавить извлечение `Key Points`.
        - [ ] Реализовать форматирование временных меток в транскрипте.
        - [ ] Улучшить логику извлечения даты и времени с учетом разных форматов и выбранного языка (если применимо).
    - [ ] 4.  Реализовать базовую проверку на дубликаты в `ProcessingService.ts` (по имени файла заметки) и применение `duplicateStrategy`.
*   **Цель:** Полная кастомизация создаваемых заметок и имен файлов через настройки, базовая обработка дубликатов.
*   **Критерии завершения:**
    *   Все настройки из `SRS.MD` доступны и работают.
    *   Имена файлов и содержимое заметок генерируются согласно шаблонам.
    *   Плагин корректно обрабатывает дубликаты согласно выбранной стратегии.
    *   Транскрипт содержит кликабельные временные метки.

---

**Итерация 4: Автоматическое отслеживание папки**

*   **Задачи:**
    - [ ] 1.  Реализовать `FileWatcherService.ts`:
        - [ ] Методы `startWatching(folderPath)` и `stopWatching()`.
        - [ ] Использовать `Vault.on('create', ...)` или `fs.watch` (через `app.vault.adapter` если это `FileSystemAdapter`) для отслеживания создания `.zip` файлов в `watchedFolderPath`.
        - [ ] При обнаружении нового файла, вызывать `ProcessingService.processZipFile()`.
    - [ ] 2.  Интегрировать `FileWatcherService` в `main.ts`:
        - [ ] Запускать отслеживание при `onload()` если `autoScanEnabled` = true и `watchedFolderPath` задан.
        - [ ] Останавливать при `onunload()`.
        - [ ] Реагировать на изменение настройки `autoScanEnabled` и `watchedFolderPath` (перезапускать отслеживание).
    - [ ] 3.  Добавить настройку `autoScanEnabled` в `SettingsTab.ts`.
*   **Цель:** Плагин автоматически обрабатывает новые ZIP-файлы, появляющиеся в отслеживаемой папке.
*   **Критерии завершения:**
    *   При копировании ZIP-файла в отслеживаемую папку, он автоматически обрабатывается плагином.
    *   Отслеживание можно включить/выключить в настройках.

---

**Итерация 5: Улучшения UI/UX и дополнительные функции**

*   **Задачи:**
    - [ ] 1.  Реализовать "Мастер первоначальной настройки" (`Setup Wizard`) в `SettingsTab.ts`.
    - [ ] 2.  Реализовать кнопку "Тестовый импорт" в `SettingsTab.ts`.
    - [ ] 3.  Реализовать кнопку "Импортировать все файлы из отслеживаемой папки сейчас" и соответствующую команду.
    - [ ] 4.  Улучшить UI настроек: визуальный выбор папок, подсказки, примеры для шаблонов, группировка, кнопка сброса (как описано в `SettingsUI.MD`).
    - [ ] 5.  Улучшить `NotificationService.ts`: более детальные и интерактивные уведомления.
    - [ ] 6.  Реализовать логирование работы плагина (`NotificationService` или отдельный `LoggingService`). Добавить кнопку "Показать логи" в настройки.
    - [ ] 7.  Реализовать индикацию статуса плагина в строке состояния Obsidian.
    - [ ] 8.  Добавить опциональный режим "Простой / Расширенный" для настроек.
*   **Цель:** Максимально удобный и дружелюбный интерфейс, дополнительные инструменты для пользователя.
*   **Критерии завершения:**
    *   Все UI/UX улучшения из `SRS.MD` и `SettingsUI.MD` реализованы.
    *   Плагин предоставляет исчерпывающую обратную связь и инструменты для управления.

---

**Итерация 6: Тестирование, отладка, документация и подготовка к релизу**

*   **Задачи:**
    - [ ] 1.  Тщательное тестирование всех функций на разных ОС (если возможно) и с разными сценариями использования (разные имена файлов, структуры ZIP-архивов Krisp, если они варьируются).
    - [ ] 2.  Отладка и исправление найденных ошибок.
    - [ ] 3.  Оптимизация производительности, если необходимо.
    - [ ] 4.  Написание пользовательской документации (минимум `README.md` с описанием установки, настройки и использования).
    - [ ] 5.  Подготовка к публикации (если планируется): проверка соответствия требованиям Obsidian Community Plugins.
*   **Цель:** Стабильный, хорошо протестированный и документированный плагин.
*   **Критерии завершения:**
    *   Плагин работает стабильно.
    *   Основные сценарии использования покрыты тестами (ручными или автоматическими, если есть возможность).
    *   Есть `README.md`.

---

Этот план является ориентировочным. Порядок некоторых задач внутри итераций может меняться, а какие-то итерации могут быть объединены или разделены в зависимости от прогресса и возникающих сложностей. Главное — регулярная обратная связь и тестирование.
